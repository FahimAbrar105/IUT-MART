<%- include('partials/header') %>

    <div class="container mx-auto px-4 py-8">
        <!-- Portfolio Header -->
        <div class="mb-8 border-b border-border pb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl font-bold text-white font-mono tracking-tight mb-2">PORTFOLIO MANAGER</h1>
                    <p class="text-text-secondary text-sm font-mono">ACCOUNT: <span class="text-white">
                            <%= user.name.toUpperCase().replace(/\d+/g, '' ).trim() %>
                        </span> // ID: <%= user.studentId || 'UNKNOWN' %>
                    </p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-6">
                    <div class="text-right">
                        <p class="text-[10px] text-text-secondary font-mono">CREDIT RATING</p>
                        <p class="text-2xl font-bold text-bull font-mono">AAA <span
                                class="text-xs text-text-secondary font-normal">(PRIME)</span></p>
                    </div>
                    <div class="text-right border-l border-border pl-6">
                        <p class="text-[10px] text-text-secondary font-mono">ASSETS UNDER MANAGEMENT</p>
                        <% let totalValue=0; if(typeof myProducts !=='undefined' ) { totalValue=myProducts.reduce((acc,
                            curr)=> acc + curr.price, 0);
                            }
                            %>
                            <p class="text-2xl font-bold text-white font-mono">৳<%= totalValue.toLocaleString() %>
                            </p>
                    </div>
                    <a href="/products/create"
                        class="px-6 py-3 bg-action hover:bg-blue-600 text-white font-mono font-bold rounded shadow-lg shadow-action/20 transition flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>INITIATE IPO</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar Navigation -->
            <aside class="lg:col-span-1">
                <nav class="bg-surface border border-border rounded-lg overflow-hidden">
                    <div class="p-4 bg-bg border-b border-border">
                        <h3 class="text-xs font-bold text-text-secondary font-mono">TERMINAL COMMANDS</h3>
                    </div>
                    <ul class="divide-y divide-border">
                        <li>
                            <a href="/products/create"
                                class="block px-4 py-3 text-sm text-text-secondary hover:bg-bg hover:text-white transition flex items-center space-x-3">
                                <i class="fas fa-plus-circle w-4"></i>
                                <span>New IPO Listing</span>
                            </a>
                        </li>
                        <li>
                            <a href="/products"
                                class="block px-4 py-3 text-sm text-text-secondary hover:bg-bg hover:text-white transition flex items-center space-x-3">
                                <i class="fas fa-globe w-4"></i>
                                <span>Global Markets</span>
                            </a>
                        </li>
                        <li>
                            <a href="/chat"
                                class="block px-4 py-3 text-sm text-text-secondary hover:bg-bg hover:text-white transition flex items-center space-x-3">
                                <i class="fas fa-envelope w-4"></i>
                                <span>Secure Comms</span>
                            </a>
                        </li>
                        <li>
                            <a href="/auth/logout"
                                class="block px-4 py-3 text-sm text-bear hover:bg-bear/10 transition flex items-center space-x-3">
                                <i class="fas fa-power-off w-4"></i>
                                <span>Terminate Session</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Portfolio Content -->
            <main class="lg:col-span-3"
                x-data="{ holdings: JSON.parse(localStorage.getItem('terminal_portfolio') || '[]') }">

                <!-- My Listings (Real Backend Data) -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center space-x-2">
                            <span class="w-1 h-5 bg-bull block"></span>
                            <span>ACTIVE POSITIONS (listings)</span>
                        </h2>
                        <span class="text-xs text-text-secondary font-mono">
                            <%= typeof myProducts !=='undefined' ? myProducts.length : 0 %> POSITIONS OPEN
                        </span>
                    </div>

                    <% if (typeof myProducts !=='undefined' && myProducts.length> 0) { %>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <% myProducts.forEach(product=> { %>
                                <div
                                    class="bg-surface border border-border rounded-lg overflow-hidden flex flex-col group hover:border-text-secondary transition">
                                    <div class="flex p-4">
                                        <div
                                            class="w-24 h-24 bg-bg rounded overflow-hidden flex-shrink-0 border border-border relative">
                                            <% if (product.images && product.images.length> 0) { %>
                                                <img src="<%= product.images[0] %>" class="w-full h-full object-cover">
                                                <% } else { %>
                                                    <div
                                                        class="w-full h-full flex flex-col items-center justify-center bg-zinc-900 relative overflow-hidden group-hover:bg-zinc-800 transition">
                                                        <!-- Tech Pattern -->
                                                        <div class="absolute inset-0 opacity-20"
                                                            style="background-image: linear-gradient(135deg, #333 25%, transparent 25%, transparent 50%, #333 50%, #333 75%, transparent 75%, transparent); background-size: 10px 10px;">
                                                        </div>
                                                        <i
                                                            class="fas fa-cube text-text-secondary/50 text-xl mb-1 relative z-10"></i>
                                                        <span
                                                            class="text-[8px] font-mono text-text-secondary/70 tracking-widest relative z-10">NO
                                                            ASSET</span>
                                                    </div>
                                                    <% } %>
                                        </div>
                                        <div class="ml-4 flex-grow">
                                            <div class="flex justify-between items-start">
                                                <h3 class="text-white font-bold truncate w-32 md:w-48">
                                                    <%= product.title %>
                                                </h3>
                                                <span class="text-bull font-mono font-bold">৳<%= product.price %></span>
                                            </div>
                                            <p class="text-xs text-text-secondary font-mono mt-1 mb-3">SECTOR: <%=
                                                    product.category.toUpperCase() %>
                                            </p>

                                            <div class="flex items-center space-x-2 mt-auto">
                                                <a href="/products/<%= product._id %>"
                                                    class="px-3 py-1 bg-border hover:bg-white/10 text-xs text-white rounded transition">VIEW</a>
                                                <form action="/products/<%= product._id %>/delete" method="POST"
                                                    class="inline"
                                                    onsubmit="return confirm('LIQUIDATE asset? This cannot be undone.')">
                                                    <button
                                                        class="px-3 py-1 bg-bear/10 hover:bg-bear text-bear hover:text-white border border-bear/20 hover:border-bear text-xs rounded transition uppercase">Liquidate</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Mini Sparkline Decoration -->
                                    <div class="h-1 w-full flex">
                                        <div class="bg-bull h-full w-[<%= Math.floor(Math.random() * 60 + 20) %>%]">
                                        </div>
                                        <div class="bg-bg h-full flex-grow"></div>
                                    </div>
                                </div>
                                <% }) %>
                        </div>
                        <% } else { %>
                            <div class="bg-surface border border-border border-dashed rounded-lg p-8 text-center">
                                <p class="text-text-secondary font-mono text-sm">NO ACTIVE SELL ORDERS (IPO) LISTED</p>
                            </div>
                            <% } %>
                </div>

                <!-- Open Orders (Limit Orders) -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center space-x-2">
                            <span class="w-1 h-5 bg-action block"></span>
                            <span>OPEN ORDERS (bids)</span>
                        </h2>
                        <span class="text-xs text-text-secondary font-mono">
                            <%= typeof myOrders !=='undefined' ? myOrders.length : 0 %> ORDERS PENDING
                        </span>
                    </div>

                    <div class="bg-surface border border-border rounded-lg overflow-hidden">
                        <% if (typeof myOrders !=='undefined' && myOrders.length> 0) { %>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm font-mono">
                                    <thead class="bg-bg text-text-secondary border-b border-border">
                                        <tr>
                                            <th class="px-4 py-3 font-bold text-xs uppercase">Date</th>
                                            <th class="px-4 py-3 font-bold text-xs uppercase">Sector</th>
                                            <th class="px-4 py-3 font-bold text-xs uppercase">Max Strike Price</th>
                                            <th class="px-4 py-3 font-bold text-xs uppercase">Status</th>
                                            <th class="px-4 py-3 font-bold text-xs uppercase text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-border">
                                        <% myOrders.forEach(order=> { %>
                                            <tr class="hover:bg-white/5 transition cursor-pointer"
                                                onclick="window.location.href='/products?sector=<%= order.sector %>&maxPrice=<%= order.maxPrice %>'">
                                                <td class="px-4 py-3 text-white">
                                                    <%= new Date(order.createdAt).toLocaleDateString() %>
                                                        <span class="text-text-secondary text-[10px] ml-1">
                                                            <%= new Date(order.createdAt).toLocaleTimeString([],
                                                                {hour: '2-digit' , minute:'2-digit'}) %>
                                                        </span>
                                                </td>
                                                <td class="px-4 py-3 text-action font-bold uppercase">
                                                    <%= order.sector %>
                                                </td>
                                                <td class="px-4 py-3 text-white">৳<%= order.maxPrice %>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <% if (order.matches && order.matches.length> 0) { %>
                                                        <span
                                                            class="px-2 py-0.5 rounded text-[10px] font-bold bg-bull/10 text-bull border border-bull/20">FILLED</span>
                                                        <% } else if (order.status==='ACTIVE' ) { %>
                                                            <span
                                                                class="px-2 py-0.5 rounded text-[10px] font-bold bg-action/10 text-action border border-action/20">ACTIVE</span>
                                                            <% } else if (order.status==='FILLED' ) { %>
                                                                <span
                                                                    class="px-2 py-0.5 rounded text-[10px] font-bold bg-bull/10 text-bull border border-bull/20">FILLED</span>
                                                                <% } else { %>
                                                                    <span
                                                                        class="px-2 py-0.5 rounded text-[10px] font-bold bg-text-secondary/10 text-text-secondary border border-border">CANCELLED</span>
                                                                    class="px-2 py-0.5 rounded text-[10px] font-bold
                                                                    bg-text-secondary/10 text-text-secondary border
                                                                    border-border">CANCELLED</span>
                                                                    <% } %>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <form action="/products/orders/<%= order._id %>/delete"
                                                        method="POST" class="inline-block"
                                                        onsubmit="event.stopPropagation(); return confirm('Cancel this limit order?');">
                                                        <button type="submit" onclick="event.stopPropagation()"
                                                            class="text-text-secondary hover:text-bear transition p-1 rounded hover:bg-bear/10">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            <!-- Matches Logic -->
                                            <% if (order.matches && order.matches.length> 0) { %>
                                                <tr class="bg-surface/50 border-b border-border">
                                                    <td colspan="4" class="p-4">
                                                        <p
                                                            class="text-[10px] font-mono text-bull font-bold mb-2 flex items-center gap-2">
                                                            <i class="fas fa-check-circle"></i>
                                                            MATCHING ASSETS FOUND (<%= order.matches.length %>)
                                                        </p>
                                                        <div
                                                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                                            <% order.matches.forEach(match=> { %>
                                                                <div
                                                                    class="flex items-center gap-3 bg-bg border border-border rounded p-2 hover:border-text-secondary transition group">
                                                                    <div
                                                                        class="w-10 h-10 bg-black rounded overflow-hidden flex-shrink-0">
                                                                        <% if (match.images && match.images.length> 0) {
                                                                            %>
                                                                            <img src="<%= match.images[0] %>"
                                                                                class="w-full h-full object-cover">
                                                                            <% } else { %>
                                                                                <div
                                                                                    class="w-full h-full flex items-center justify-center text-text-secondary">
                                                                                    <i class="fas fa-cube text-xs"></i>
                                                                                </div>
                                                                                <% } %>
                                                                    </div>
                                                                    <div class="flex-grow min-w-0">
                                                                        <h4
                                                                            class="text-white text-xs font-bold truncate">
                                                                            <%= match.title %>
                                                                        </h4>
                                                                        <p class="text-[10px] text-bull font-mono">৳<%=
                                                                                match.price %>
                                                                        </p>
                                                                    </div>
                                                                    <a href="/products/<%= match._id %>"
                                                                        class="px-2 py-1 text-[10px] bg-action text-white rounded hover:bg-blue-600 transition">VIEW</a>
                                                                </div>
                                                                <% }) %>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% } %>
                                                    <% }) %>
                                    </tbody>
                                </table>
                            </div>
                            <% } else { %>
                                <div
                                    class="p-8 flex flex-col items-center justify-center border border-dashed border-border/50 rounded-lg bg-bg/30">
                                    <div
                                        class="w-12 h-12 rounded-full bg-surface border border-border flex items-center justify-center mb-3">
                                        <i class="fas fa-radar text-text-secondary/50 text-xl"></i>
                                    </div>
                                    <p class="text-text-secondary font-mono text-xs tracking-wider mb-1">NO OPEN PRICE
                                        ALERTS</p>
                                    <span class="text-[10px] text-text-secondary/50 font-mono">system.status ===
                                        idle</span>
                                </div>
                                <% } %>
                    </div>
                </div>

                <!-- Client-Side Holdings (LocalStorage) -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-white flex items-center space-x-2">
                            <span class="w-1 h-5 bg-action block"></span>
                            <span>SAVED HOLDINGS & POSITIONS</span>
                        </h2>
                        <button @click="localStorage.removeItem('terminal_portfolio'); holdings = []"
                            class="text-[10px] text-text-secondary hover:text-bear">CLEAR RECORD</button>
                    </div>

                    <div x-show="holdings.length === 0"
                        class="bg-surface border border-border border-dashed rounded-lg p-8 text-center">
                        <p class="text-text-secondary font-mono text-sm">NO LONG POSITIONS HELD</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-show="holdings.length > 0">
                        <template x-for="item in holdings" :key="item.id">
                            <div
                                class="bg-surface border border-border rounded-lg overflow-hidden flex flex-col relative group">
                                <div class="absolute top-2 right-2 px-2 py-0.5 rounded text-[10px] font-mono border"
                                    :class="item.type === 'LONG' ? 'bg-bull/10 text-bull border-bull/20' : 'bg-action/10 text-action border-action/20'"
                                    x-text="item.type">
                                </div>

                                <div class="flex p-4">
                                    <div
                                        class="w-16 h-16 bg-bg rounded overflow-hidden flex-shrink-0 border border-border">
                                        <template x-if="item.image">
                                            <img :src="item.image" class="w-full h-full object-cover">
                                        </template>
                                        <template x-if="!item.image">
                                            <div
                                                class="w-full h-full flex flex-col items-center justify-center bg-zinc-900 relative overflow-hidden">
                                                <div class="absolute inset-0 opacity-20"
                                                    style="background-image: linear-gradient(135deg, #333 25%, transparent 25%, transparent 50%, #333 50%, #333 75%, transparent 75%, transparent); background-size: 10px 10px;">
                                                </div>
                                                <i
                                                    class="fas fa-cube text-text-secondary/50 text-xs mb-1 relative z-10"></i>
                                                <span
                                                    class="text-[6px] font-mono text-text-secondary/70 tracking-widest relative z-10">NO
                                                    ASSET</span>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="ml-4 flex-grow">
                                        <h3 class="text-white font-bold text-sm" x-text="item.title"></h3>
                                        <span class="text-white font-mono font-bold text-sm"
                                            x-text="'৳' + item.price"></span>
                                        <p class="text-[10px] text-text-secondary font-mono mt-1"
                                            x-text="'EXECUTED: ' + new Date(item.timestamp).toLocaleDateString()"></p>
                                    </div>
                                </div>
                                <div class="px-4 pb-3">
                                    <a :href="'/products/' + item.id"
                                        class="block w-full text-center py-1.5 bg-bg hover:bg-border text-xs text-text-secondary hover:text-white rounded transition">VIEW
                                        ASSET</a>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <%- include('partials/footer') %>